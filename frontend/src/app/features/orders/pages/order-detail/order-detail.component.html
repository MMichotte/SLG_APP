<div class="page">
  <h1>ORDER</h1>

  <button pButton pRipple type="button" icon="pi pi-arrow-left" class="p-button-sm p-button-info"
    (click)="router.navigate(['orders']);"></button>

  <div class="control">
    <div class="supplier inline">
      <label class="myLabel">Supplier:</label>
      <span class="supplier-name" *ngIf="order?.status !== EOrderStatus.OPEN || !auth.hasMinAccess(EUserRoles.USER)">{{selectedLightSupplier?.name}}</span>
      <p-autoComplete *ngIf="order?.status === EOrderStatus.OPEN && auth.hasMinAccess(EUserRoles.USER)" appendTo="body" [(ngModel)]="selectedLightSupplier" [suggestions]="lightSuppliersFiltered"
        (completeMethod)="searchSupplier($event.query)" field="name" [dropdown]="true" (onSelect)="onChangeSupplier()">
      </p-autoComplete>
    </div>

    <div class="inline">
      <label class="myLabel">Status:</label>
      <span class="orderStatus" [ngClass]="{
        'order-status-open': (order?.status === EOrderStatus.OPEN),
        'order-status-ordered': (order?.status === EOrderStatus.ORDERED),
        'order-status-PD': (order?.status === EOrderStatus.PD),
        'order-status-closed': (order?.status === EOrderStatus.CLOSED)
      }">{{order?.status}}</span>
    </div>

    <div>
      <div class="btns" *ngIf="auth.hasMinAccess(EUserRoles.USER)">
        <button *ngIf="order?.status === EOrderStatus.OPEN" pButton pRipple type="button" icon="pi pi-file-pdf" label="Generate Order"
          (click)="onGenerateOrder()"></button>
        <button *ngIf="order?.status === EOrderStatus.ORDERED" pButton pRipple type="button" icon="pi pi-tag" label="Generate Bill"
          (click)="onProcessOrder()"></button>
      </div>
    </div>
  </div>

  <p-panel header="Add Product" class="form">
    <app-product-order-form [order]="order" [(currentProduct)]="selectedProductOrder"
      [existingProducts]="productOrders" (refreshTable)="refreshProducts()"></app-product-order-form>
  </p-panel>

  <div class="dtable">
    <p-table #dt [columns]="cols" [value]="productOrders" [autoLayout]="true" [paginator]="true" [scrollable]="true"
      [rows]="25" [rowsPerPageOptions]="[25,50,100]" [sortField]="cols[4].field" [sortOrder]="-1" selectionMode="single"
      [(selection)]="selectedProductOrder" styleClass="p-datatable-sm" [loading]="loadingData">

      <ng-template pTemplate="header" let-columns>
        <tr>
          <th *ngFor="let col of columns" [pSortableColumn]="col.field" [ngStyle]="{'width': col.width}">
            {{col.header}}
            <p-sortIcon [field]="col.field"></p-sortIcon>
          </th>
          <th style="width: 6rem"></th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-rowData let-columns="columns">
        <tr [pSelectableRow]="rowData">
          <td *ngFor="let col of columns" [ngStyle]="{'width': col.width}">
            <span [ngClass]="{
                'productStatus': (col.field === 'status'),
                'status-pending': (col.field === 'status' && rowData[col.field] === EProductOrderStatus.PENDING),
                'status-ordered': (col.field === 'status' && rowData[col.field] === EProductOrderStatus.ORDERED),
                'status-received': (col.field === 'status' && rowData[col.field] === EProductOrderStatus.RECEIVED),
                'status-BO': (col.field === 'status' && rowData[col.field] === EProductOrderStatus.BO)
              }">{{rowData[col.field]}}</span>
          </td>
          <td style="width: 6rem;">
            <button pButton pRipple type="button" icon="pi pi-trash" class="p-button-danger p-button-sm"
              title="Remove product" (click)="removeProduct(rowData)"
              *ngIf="rowData.status !== EProductOrderStatus.RECEIVED && order?.status !== EOrderStatus.ORDERED && auth.hasMinAccess(EUserRoles.USER)"></button>
          </td>
        </tr>
      </ng-template>

    </p-table>
  </div>

</div>

<p-confirmDialog key="local_confirm" [style]="{width: '30%'}" acceptLabel="Place order" acceptIcon="pi pi-send"
  rejectLabel="Only generate pdf" rejectIcon="pi pi-file-pdf" rejectButtonStyleClass="p-button-info"
  defaultFocus="accept"></p-confirmDialog>

  <!--*ngIf="auth.hasMinAccess(EUserRoles.USER)"-->